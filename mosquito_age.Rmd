---
title: "Figure 5"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

## Packages

```{r message = FALSE}
library(readr)
library(dplyr)
library(purrr)
```

## Capacity formula

The expression of the vectorial capacity as a function of as:

$$
C(a) = M\times B^2  \frac{p(a) \times i(a)}{g(a)} e^{-\frac{g(a)}{m(a)}}
$$
Where $M = 20$ is the ratio of mosquitoes to humans and $B = 1/3$ is the
mosquito biting rate. These parameters were not studied here and will thus be
assumed to be constants independent of age. Sporozoite prevalences $p(a)$ and
sporozoite intensities (given that there is infection) $i(a)$ are informed by
experiment 1, mosquitoes survival rates $g(a)$ are informed by experiment 2 and
the parasite maturation rate is informed by experiment 3. We will assume that
the vector competence and survival and the parasite maturation are independent
from each other. We'll further assume that $p(a)$ follows a beta distribution,
the parameters of which will be estimated from the binomial estimate and its
confidence interval from the presence/absence raw data and we will assume too
that $m$ follows a gamma distribution, the parameters of which are estimated in
a similar way. Values for $p(a)$ and $m$ will then be randomly drawn from these
beta and gamma distributions respectively. Given that results from experiment 1
show that the distributions of sporozoites intensities do not look like any
known distribution, it will probably be better to perform non-parametric
bootstrapping of the data in order to generate values of sporozoites
intensities. As for the mosquito survival rates, we will simply compute the
expected life expectancy from the non-parametrically boostrapped data.

## Data from experiment 1

Loading and preparing the data:

```{r message = FALSE}
fig2 <- "data/fig2_sporozoite_data.txt" |>
  read_delim() |> 
  filter(age_class != "8-day-old") |> 
  mutate(intensity = 10^(-(Ct - 40) / 3.3))
```

The names of the age classes:

```{r}
age_names <- sort(unique(fig2$age_class))
```

### Sporozoite prevalences

A function that converts confidence intervals boundary values of a proportion
into parameters of a probability distribution:

```{r}
ci2pars <- function(ci, f, pars, p = .95) {
  p <- (1 - p) / 2
  
  f_par <- function(par1, par2) {
    c(f(p, par1, par2), f(1 - p, par1, par2))
  }

  f_fit <- function(pars) {
    sum((f_par(pars[1], pars[2]) - ci)^2)
  }
  
  optim(pars, f_fit)$par
}
```

The shape parameters of the beta distribution of the mean sporozoites
prevalences ($p(a)$):

```{r warning = FALSE}
p_par <- fig2 |> 
  group_by(age_class) |> 
  summarize(x   = sum(positive), n = length(positive)) |> 
  mutate(prop   = map2(x, n, prop.test),
         ci     = map(prop, magrittr::extract2, "conf.int"),
         shapes = map(ci, ci2pars, qbeta, 1:2)) |> 
  pull(shapes) |> 
  setNames(age_names)
```

### Sporozoite intensities

The data on sporozoites intensities, given infection:

```{r}
i <- fig2 |> 
  filter(positive > 0) |> 
  group_by(age_class) |> 
  group_split() |> 
  map(pull, intensity) |> 
  setNames(age_names)
```

They don't really look like any known distribution:

```{r}
hist(log(i$`4-day-old`), n = 50)
hist(log(i$`12-day-old`), n = 50)
```

## Experiment 2

Loading and preparing the data:

```{r message = FALSE}
fig3 <- "data/fig3_survival_data.txt" |>
  read_delim() |> 
  filter(age_class != "8-day-old")
```

The data for 4-day old:

```{r}
age4 <- fig3 |> 
  filter(age_class == "4-day-old") |> 
  pull(daysPI)
```

The data for 12-day old:

```{r}
inf_status <- sort(unique(fig3$infection_status))

age12 <- fig3 |> 
  filter(age_class == "12-day-old") |> 
  group_by(infection_status) |> 
  group_split() |> 
  map(pull, daysPI) |> 
  setNames(inf_status)
```

## Experiment 3

Loading and preparing the data:

```{r message = FALSE}
fig4 <- read_delim("data/fig4_EIP_data.txt")
```

```{r fig4a, message = FALSE}
fig4a <- fig4 |>
  select(dpi, spz) |> 
  na.exclude() |> 
  mutate_at("spz", as.logical)
```

The parameters of the gamma distribution that models the distribution of the
maturation rate:

```{r compute_m, warning = FALSE, dependson = "fig4a"}
mod <- glm(spz ~ dpi, binomial, fig4a)
invtransf <- family(mod)$linkinv

xs <- seq(min(fig4a$dpi), max(fig4a$dpi), le = 1000)
ys <- predict(mod, data.frame(dpi = xs), se.fit = TRUE)

ci <- tibble(xs  = xs,
             low = invtransf(ys$fit - 1.96 * ys$se.fit),
             upp = invtransf(ys$fit + 1.96 * ys$se.fit))

m <- 1 / ci2pars(c(filter(ci, .5 < upp)$xs[1],
                   filter(ci, .5 < low)$xs[1]), qgamma, 1:2)
```

## Simulating data

The simulator of a distribution of values of the vectorial capacity:

```{r simulator, dependson = "compute_m"}
M <- 20
B <- 1 / 3
MB2 <- M * B * B

simulate <- function(p, i, g, N = 1e7) {
  p_val <- do.call(rbeta, c(list(N), unname(p)))
  i_val <- sample(i, N, replace = TRUE)
  g_val <- 1 / sample(g, N, replace = TRUE)
  m_val <- do.call(rgamma, c(list(N), m))
  MB2 * p_val * i_val * exp(-g_val / m_val) / g_val
}
```

Performing the simulations for the 4 groups:

```{r simulations, dependson = "simulator"}
sim_age4           <- simulate(p_par$`4-day-old`,   i$`4-day-old`, age4)
sim_age12_ExpInf   <- simulate(p_par$`12-day-old`, i$`12-day-old`, age12$`Exposed-infected`)
sim_age12_ExpNoinf <- simulate(p_par$`12-day-old`, i$`12-day-old`, age12$`Exposed-uninfected`)
sim_age12_Uninf    <- simulate(p_par$`12-day-old`, i$`12-day-old`, age12$`Uninfected control`)
```

Checking that stationarity has been reached:

```{r dependson = "simulations"}
walk(list(sim_age4, sim_age12_ExpInf, sim_age12_ExpNoinf, sim_age12_Uninf),
     function(x, ...) plot(cummean(x), type = "l", ...))
```

The ranges of values for the simulated vectorial capacities:

```{r dependson = "simulations"}
range(sim_age4)
range(sim_age12_ExpInf)
range(sim_age12_ExpNoinf)
range(sim_age12_Uninf)
```

Computing densities of transformed simulated VC data:

```{r computes_density}
f <- log
from <- 0
to <- 36
density2 <- function(...) density(..., from = from, to = to)

d1 <- density2(f(sim_age4))
d2 <- density2(f(sim_age12_ExpInf))
d3 <- density2(f(sim_age12_ExpNoinf))
d4 <- density2(f(sim_age12_Uninf))
```

A function that adds boxplots to a figure:

```{r add_boxplot}
add_boxplot <- function(x, y, f = log, t = 1e-20, eps = 5e-6, lwd = 2, col = 1) {
  x <- as.vector(boxplot(f(x[x > t]), plot = FALSE)$stats)
  segments2 <- function(...) segments(..., lwd = lwd, col = col)
  segments2(0, y, x[2], y)
  segments2(x[4], y, x[5], y)
  segments2(x[3], y - eps, x[3], y + eps)
  polygon(c(x[2], x[4], x[4], x[2]), rep(c(y - eps, y + eps), each = 2), lwd = lwd, border = col)
}
```

Figure 5:

```{r dependson = "computes_density", dependson = "add_boxplot", dependson = "simulations"}
lines2 <- function(...) lines(..., lwd = 2)

plot(NA, xlim = c(from, to), ylim = c(0, .00031), xaxs = "i", yaxs = "i",
     xlab = "log(vectorial capacity)", ylab = "density", axes = FALSE)
axis(1)
axis(2, seq(0, 25, by = 5) / 1e5)

with(d1, lines2(x, y))
with(d2, lines2(x, y, col = 2))
with(d3, lines2(x, y, col = 3))
with(d4, lines2(x, y, col = 4))

epsilon <- 8e-6
add_boxplot(sim_age4,           .000295 + epsilon, col = 1)
add_boxplot(sim_age12_Uninf,    .00028  + epsilon, col = 4)
add_boxplot(sim_age12_ExpNoinf, .000265 + epsilon, col = 3)
add_boxplot(sim_age12_ExpInf,   .00025  + epsilon, col = 2)

legend("right",
       legend = c("4-day old",
                  "12-day old uninfected control",
                  "12-day old exposed uninfected",
                  "12-day old exposed infected"),
       col = c(1, 4:2), lty = 1, lwd = 2, bty = "n")
```


